const response = await fetch('/download',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url:url})});
const result = await response.json();
clearInterval(itv);

if(response.ok){
bar.style.width='100%';
st.innerText=dict[currentLang].ready;

const isIOS=/iPad|iPhone|iPod/.test(navigator.userAgent);
if(isIOS){window.open(result.download_url,'_blank');}
else{
const link=document.createElement('a');
link.href=result.download_url;
link.setAttribute('download','');
link.target='_blank';
document.body.appendChild(link);link.click();link.remove();
}

setTimeout(()=>{st.innerText=dict[currentLang].check;},2000);
setTimeout(()=>{location.reload();},7000);
}else{alert(result.error);location.reload();}
}catch(e){clearInterval(itv);alert("Connection Error");location.reload();}
}

// PWA Install
window.addEventListener('beforeinstallprompt',(e)=>{
e.preventDefault();
deferredPrompt=e;
if(/iPad|iPhone|iPod|Android/.test(navigator.userAgent)){document.getElementById('pwaInstall').style.display='inline-block';}
});

document.getElementById('pwaInstall').addEventListener('click',async()=>{
if(deferredPrompt){deferredPrompt.prompt();
const {outcome}=await deferredPrompt.userChoice;
if(outcome==='accepted')document.getElementById('pwaInstall').style.display='none';
deferredPrompt=null;}
});

if('serviceWorker' in navigator){navigator.serviceWorker.register('/sw.js').catch(err=>console.log("SW error:",err));}
window.onload=()=>{updateLang('ar');};
document.getElementById('dlBtn').addEventListener('click',startProcess);
</script>

</body>
</html>
