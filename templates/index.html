<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EasyDown</title>
<style>
body { background:#111827; color:white; font-family:sans-serif; text-align:center; padding:30px; }
input { width:90%; padding:15px; border-radius:12px; border:none; margin-bottom:15px; }
button { padding:15px 25px; border:none; border-radius:12px; background:#00d2ff; color:black; font-weight:bold; cursor:pointer; }
#status { margin-top:20px; }
</style>
</head>
<body>

<h1>EasyDown</h1>
<input type="url" id="videoUrl" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§">
<br>
<button id="downloadBtn">ØªØ­Ù…ÙŠÙ„</button>
<div id="status"></div>

<script>
const videoUrl = document.getElementById('videoUrl');
const downloadBtn = document.getElementById('downloadBtn');
const statusDiv = document.getElementById('status');

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isAndroid = /Android/.test(navigator.userAgent);

let downloading = false;
let newTab = null;

downloadBtn.addEventListener('click', async () => {
    const url = videoUrl.value.trim();
    if (!url) { statusDiv.innerHTML="âš ï¸ Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø·"; return; }
    if (downloading) return;
    downloading = true;
    downloadBtn.disabled = true;

    // ğŸŒŸ Ø§ÙØªØ­ Ù†Ø§ÙØ°Ø© ÙØ§Ø±ØºØ© Ù…Ø¨Ø§Ø´Ø±Ø© Ø¹Ù†Ø¯ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø²Ø±
    if (isIOS) {
        newTab = window.open('about:blank', '_blank');
        if (!newTab) { statusDiv.innerHTML="âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©"; downloading=false; downloadBtn.disabled=false; return; }
    }

    statusDiv.innerHTML="â³ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ...";

    try {
        const response = await fetch('/download', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({url:url})
        });
        const data = await response.json();
        if (!data.success) throw new Error(data.error);

        const fileUrl = window.location.origin + data.download_url;
        const filename = data.filename || "video.mp4";

        // âœ… iOS: ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„Ù†Ø§ÙØ°Ø© Ø§Ù„Ù…ÙØªÙˆØ­Ø© Ø¥Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
        if (isIOS && newTab) {
            newTab.location.href = fileUrl;
            statusDiv.innerHTML="ğŸ“± Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø¶ØºØ· Share â†’ Save Video Ø£Ùˆ Documents";
        }
        // ğŸ¤– Android
        else if (isAndroid && navigator.share) {
            try {
                const videoResponse = await fetch(data.download_url);
                const blob = await videoResponse.blob();
                const file = new File([blob], filename, { type:'video/mp4' });
                if (navigator.canShare && navigator.canShare({ files:[file] })) {
                    await navigator.share({ files:[file], title:filename });
                    statusDiv.innerHTML="âœ… ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©";
                } else throw new Error("Cannot share file");
            } catch {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                statusDiv.innerHTML="âœ… Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
            }
        }
        // ğŸ’» Desktop
        else {
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            statusDiv.innerHTML="âœ… Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        }

    } catch(e) {
        console.error(e);
        statusDiv.innerHTML="âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        if (newTab) newTab.close();
    }

    downloading=false;
    downloadBtn.disabled=false;
});
</script>

</body>
</html>
