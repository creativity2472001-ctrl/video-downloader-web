<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>EasyDown</title>

<style>
body {
    background: #111827;
    color: white;
    font-family: sans-serif;
    text-align: center;
    padding: 30px;
}
input {
    width: 90%;
    padding: 15px;
    border-radius: 12px;
    border: none;
    margin-bottom: 15px;
}
button {
    padding: 15px 25px;
    border: none;
    border-radius: 12px;
    background: #00d2ff;
    color: black;
    font-weight: bold;
    cursor: pointer;
}
#status {
    margin-top: 20px;
}
</style>
</head>
<body>

<h1>EasyDown</h1>

<input type="url" id="videoUrl" placeholder="Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø· Ù‡Ù†Ø§">
<br>
<button id="downloadBtn">ØªØ­Ù…ÙŠÙ„</button>

<div id="status"></div>

<script>
const videoUrl = document.getElementById('videoUrl');
const statusDiv = document.getElementById('status');
const downloadBtn = document.getElementById('downloadBtn');

const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
const isAndroid = /Android/.test(navigator.userAgent);

let downloading = false;

async function handleDownload() {
    const url = videoUrl.value.trim();
    if (!url) {
        statusDiv.innerHTML = "âš ï¸ Ø§Ù„ØµÙ‚ Ø§Ù„Ø±Ø§Ø¨Ø·";
        return;
    }

    if (downloading) return;

    downloading = true;
    downloadBtn.disabled = true;
    statusDiv.innerHTML = "â³ Ø¬Ø§Ø±ÙŠ ØªÙ†Ø²ÙŠÙ„ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±...";

    try {
        // Ø·Ù„Ø¨ Ø§Ù„ØªÙ†Ø²ÙŠÙ„ Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
        const response = await fetch('/download', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ url: url })
        });

        const data = await response.json();

        if (!data.success) {
            throw new Error(data.error);
        }

        const fileUrl = data.download_url; // Ø±Ø§Ø¨Ø· Ù…Ø¨Ø§Ø´Ø± Ø¥Ù„Ù‰ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ Ø¹Ù„Ù‰ Ø§Ù„Ø³ÙŠØ±ÙØ±
        const filename = data.filename || "video.mp4";

        // ===============================
        // ğŸ iOS â€” ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙÙŠ Safari / Documents
        // ===============================
        if (isIOS) {
            const newTab = window.open(fileUrl, '_blank');
            if (!newTab) {
                statusDiv.innerHTML = "âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø³Ù…Ø§Ø­ Ø¨ÙØªØ­ Ø§Ù„Ù†ÙˆØ§ÙØ° Ø§Ù„Ù…Ù†Ø¨Ø«Ù‚Ø©";
            } else {
                statusDiv.innerHTML = "ğŸ“± Ø§ÙØªØ­ Ø§Ù„ÙÙŠØ¯ÙŠÙˆ ÙˆØ§Ø¶ØºØ· Ù…Ø´Ø§Ø±ÙƒØ© â†’ Save Video Ø£Ùˆ Ø§Ø®ØªØ± Documents";
            }
        }

        // ===============================
        // ğŸ¤– Android â€” Ù…Ø´Ø§Ø±ÙƒØ© Ø§Ù„Ù…Ù„Ù Ø¥Ø°Ø§ Ù…Ù…ÙƒÙ†
        // ===============================
        else if (isAndroid && navigator.share) {
            try {
                const videoResponse = await fetch(fileUrl);
                const blob = await videoResponse.blob();
                const file = new File([blob], filename, { type: 'video/mp4' });

                if (navigator.canShare && navigator.canShare({ files: [file] })) {
                    await navigator.share({ files: [file], title: filename });
                    statusDiv.innerHTML = "âœ… ØªÙ…Øª Ø§Ù„Ù…Ø´Ø§Ø±ÙƒØ©";
                } else {
                    throw new Error("Cannot share file");
                }

            } catch {
                const link = document.createElement('a');
                link.href = fileUrl;
                link.download = filename;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                statusDiv.innerHTML = "âœ… Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
            }
        }

        // ===============================
        // ğŸ’» Desktop
        // ===============================
        else {
            const link = document.createElement('a');
            link.href = fileUrl;
            link.download = filename;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            statusDiv.innerHTML = "âœ… Ø¨Ø¯Ø£ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
        }

    } catch (error) {
        console.error(error);
        statusDiv.innerHTML = "âŒ ÙØ´Ù„ Ø§Ù„ØªØ­Ù…ÙŠÙ„";
    }

    downloading = false;
    downloadBtn.disabled = false;
}

downloadBtn.addEventListener('click', handleDownload);
</script>

</body>
</html>
